app-id: org.tug.texworks
runtime: org.kde.Platform
runtime-version: '5.15-22.08'
sdk: org.kde.Sdk
command: texworks
rename-desktop-file: texworks.desktop
rename-appdata-file: texworks.appdata.xml
rename-icon: TeXworks
finish-args:
#  - --socket=wayland
  - --socket=x11
  - --share=ipc
  - --device=dri
  - --filesystem=host
  - --env=TEXMFCACHE=$XDG_CACHE_HOME
  - --env=SESSION_MANAGER= # required to avoid Qt warning
  - --env=PATH=/app/texlive/bin/x86_64-linux:/app/texlive/bin/aarch64-linux:/app/bin:/usr/bin # required to find texlive binaries
  - --env=PERL5LIB=/app/texlive/lib/perl5/site_perl/5.34.0/:/app/texlive/lib/perl5/5.34.0/ # add include paths for Perl @INC variable
  - --env=LD_LIBRARY_PATH=/app/texlive/lib/:/app/texlive/lib/perl5/5.34.0/x86_64-linux/CORE/:/app/texlive/lib/perl5/5.34.0/aarch64-linux/CORE/ # add library paths
add-extensions:
  org.freedesktop.Sdk.Extension.texlive:
    version: '22.08'
    directory: texlive # this is relative to /app
    no-autodownload: true

modules:
  - shared-modules/lua5.4/lua-5.4.json # required for TeXworks's lua scripting plugin
  
  - name: boost # Build requirement of poppler
    sources:
      - type: archive
        url: https://boostorg.jfrog.io/artifactory/main/release/1.80.0/source/boost_1_80_0.tar.bz2
        sha256: 1e19565d82e43bc59209a168f5ac899d3ba471d55c7610c677d4ccf2c9c500c0
    buildsystem: simple
    build-commands:
      - ./bootstrap.sh --prefix=/app --with-libraries=system
      - ./b2 install

  - name: poppler # PDF rendering library used by TeXworks
    sources:
      - type: archive
        url: https://poppler.freedesktop.org/poppler-22.09.0.tar.xz
        sha256: d7a8f748211359cadb774ba3e18ecda6464b34027045c0648eb30d5852a41e2e
    buildsystem: cmake-ninja
    config-opts:
      - -DENABLE_GOBJECT_INTROSPECTION=OFF
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
      - /lib/*.a
      - /lib/*.la
      - /share/man

  - name: poppler-data # Encoding data for CJK documents
    sources:
      - type: archive
        url: https://poppler.freedesktop.org/poppler-data-0.4.11.tar.gz
        sha256: 2cec05cd1bb03af98a8b06a1e22f6e6e1a65b1e2f3816cb3069bb0874825f08c
    buildsystem: simple
    build-commands:
      - make prefix=/app install
    cleanup:
      - /share/pkgconfig

  - name: hunspell # Spell checking library used by TeXworks
    sources:
      - type: archive
        url: https://github.com/hunspell/hunspell/archive/v1.7.1.tar.gz
        sha256: 6e3557624c608b3e6525b8bd277706db4f5a857c28fdb3cfa8d0d2b67776da8a
    buildsystem: simple
    build-commands:
      - autoreconf -vfi
      - ./configure --prefix=/app
      - make -j
      - make install
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
      - /lib/*.a
      - /lib/*.la
      - /share/man

  - name: libreoffice-dictionaries # Spell checking dictionaries
    sources:
      - type: archive
        url: https://github.com/LibreOffice/dictionaries/archive/libreoffice-7.3.6.2.tar.gz
        sha256: b2f90fb06a38e8816e07ee87428fc67d47bebf448993c038ba5854dac28d3f34
    buildsystem: simple
    build-commands:
      # Only install languages the TeXworks UI has been translated to
      - for LANG in af ar ca cs de en es fr it nl pl pt ru sl tr; do
          for DIC in $(find . -iname "${LANG}*.dic"); do
            AFF="$(dirname "${DIC}")/$(basename "${DIC}" ".dic").aff";
            if [ ! -f "${AFF}" ]; then continue; fi;
            echo "Installing $(basename ${DIC} .dic)";
            install -D -t /app/share/hunspell "${DIC}";
            install -D -t /app/share/hunspell "${AFF}";
          done;
        done

  - name: texlive-mountpoint # Mount point for org.freedesktop.Sdk.Extension.texlive
    buildsystem: simple
    build-commands:
      - mkdir -p /app/texlive

  - name: manual # The TeXworks manual
    sources:
      - type: archive
        url: https://github.com/TeXworks/manual/releases/download/2021-03-08/TeXworks-manual-html-20210308173322-7d24168.zip
        sha256: b3fea63be210367f24d2d0a70c8e272f107edc4f53e241ec19c61e63eee99569
    buildsystem: simple
    build-commands:
      - install -d /app/share/doc/texworks-help
      - cp -ra * /app/share/doc/texworks-help

  - name: texworks
    sources:
      - type: git
        url: https://github.com/TeXworks/texworks.git
        tag: release-0.6.7
        commit: 23c4c741572f86980b0c98988cca4a3db81c52d0
      - type: patch
        path: appdata.patch
    buildsystem: cmake-ninja
    config-opts:
      - -DTW_BUILD_ID=flatpak
      - -DTeXworks_DIC_DIR=/app/share/hunspell
